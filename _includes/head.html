<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,minimum-scale=1">

  <title>{% if page.title %}{{ page.title | escape }}{% else %}{{ site.title | escape }}{% endif %}</title>
  <meta name="description" content="{% if page.excerpt %}{{ page.excerpt | strip_html | strip_newlines | truncate: 160 }}{% else %}{{ site.description }}{% endif %}">

  <link rel="canonical" href="{{ page.url | replace:'index.html','' | prepend: site.baseurl | prepend: site.url }}">
  <link rel="alternate" type="application/rss+xml" title="{{ site.title }}" href="{{ "/feed.xml" | prepend: site.baseurl | prepend: site.url }}">

  {% include fb_tags.html %}

  <script type="application/ld+json">
  {% include metadata.json %}
  </script>

  <link rel="stylesheet" href="{{ site.css_url }}/styles.css">

  <link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
  <!-- <link rel="manifest" href="/manifest.json"> -->
  <!-- <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#efae0a"> -->
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="msapplication-TileImage" content="/mstile-144x144.png">
  <meta name="theme-color" content="#233947">

  <!-- Allow inline math using $ and automatically break long math lines -->
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
      },
      CommonHTML: {
        linebreaks: {
          automatic: true,
        },
      },
    });
  </script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_CHTML' async></script>

  <!-- Include Turbolinks to make page loads fast -->
  <!-- https://github.com/turbolinks/turbolinks -->
  <script src="{{ site.js_url }}/turbolinks.js"></script>
  <script>
    // Run MathJax when Turbolinks navigates to a page
    document.addEventListener("turbolinks:load", () => {
      if (window.MathJax)
        MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    })

    const togglerId = 'js-sidebar-toggle';
    const textbookId = 'js-textbook';
    const togglerActiveClass = 'is-active';
    const textbookActiveClass = 'js-show-sidebar';

    const getToggler = () => document.getElementById(togglerId);
    const getTextbook = () => document.getElementById(textbookId);

    /**
     * Toggles sidebar and menu icon
     */
    const toggleSidebar = () => {
      const toggler = getToggler();
      const textbook = getTextbook();

      if (textbook.classList.contains(textbookActiveClass)) {
        textbook.classList.remove(textbookActiveClass);
        toggler.classList.remove(togglerActiveClass);
      } else {
        textbook.classList.add(textbookActiveClass);
        toggler.classList.add(togglerActiveClass);
      }
    }

    /**
     * Auto-close sidebar on smaller screens after page load.
     *
     * Having the sidebar be open by default then closing it on page load for
     * small screens gives the illusion that the sidebar closes in response
     * to selecting a page in the sidebar. However, it does cause a bit of jank
     * on the first page load.
     *
     * Since we don't want to persist state in between page navigation, this is
     * the best we can do while optimizing for larger screens where most
     * viewers will read the textbook.
     *
     * Keep the variable below in sync with the tablet breakpoint value in
     * _sass/inuitcss/tools/_tools.mq.scss
     *
     */
    const autoCloseSidebarBreakpoint = 740;

    // Set up event listener for sidebar toggle button
    document.addEventListener("turbolinks:load", () => {
      getToggler().addEventListener('click', toggleSidebar);

      // This assumes that the sidebar is open by default
      if (window.innerWidth < autoCloseSidebarBreakpoint)
        toggleSidebar()
    })

    /**
     * Preserve sidebar scroll when navigating between pages
     */
    let sidebarScrollTop = 0;
    const getSidebar = () => document.getElementById('js-sidebar');

    document.addEventListener("turbolinks:before-visit", () => {
      sidebarScrollTop = getSidebar().scrollTop;
    })

    document.addEventListener("turbolinks:load", () => {
      getSidebar().scrollTop = sidebarScrollTop;
    })
  </script>
</head>
