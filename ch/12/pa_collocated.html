
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>12.1. Finding Collocated Sensors &#8212; Principles and Techniques of Data Science</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet">
  <link href="../../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/custom.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="12.2. Exploring and Cleaning AQS Sensor Data" href="pa_cleaning_aqs.html" />
    <link rel="prev" title="12. Case Study: Data Science for Accurate and Timely Air Quality Measurements" href="pa_intro.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-113006011-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Principles and Techniques of Data Science</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <p class="caption">
 <span class="caption-text">
  Frontmatter
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../preface.html">
   To the Reader
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../prereqs.html">
   Prerequisites
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../notation.html">
   Notation
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  The Data Science Lifecycle
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../01/lifecycle_intro.html">
   1. The Data Science Lifecycle
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../01/lifecycle_question.html">
     1.1. Asking a Question
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01/lifecycle_obtain.html">
     1.2. Obtaining Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01/lifecycle_data.html">
     1.3. Understanding the Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01/lifecycle_world.html">
     1.4. Understanding the World
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../01/lifecycle_map.html">
     1.5. Chapter Mapping to the Lifecycle
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../02/data_scope_intro.html">
   2. Questions and Data Scope
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/data_scope_big_data_hubris.html">
     2.1. Big Data and New Opportunities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/data_scope_construct.html">
     2.2. Target Population, Access Frame, Sample
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/data_scope_protocols.html">
     2.3. Instruments and Protocols
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/data_scope_natural.html">
     2.4. Measuring Natural Phenomenon
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/data_scope_accuracy.html">
     2.5. Accuracy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/data_scope_summary.html">
     2.6. Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../02/data_scope_exercises.html">
     2.7. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../03/theory_intro.html">
   3. Simulation and Data Design
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/theory_urn.html">
     3.1. The Urn Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/theory_election.html">
     3.2. Simulating Election Polls: Bias, Variance, and Big Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/theory_vaccine_efficacy.html">
     3.3. Simulating a Randomized Trial: Vaccine Efficacy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/theory_measurement_error.html">
     3.4. Measurement Error: Air Quality Variation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/theory_summary.html">
     3.5. Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../03/theory_exercises.html">
     3.6. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../04/modeling_intro.html">
   4. Modeling and Summary Statistics
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/modeling_simple.html">
     4.1. The Constant Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/modeling_loss_functions.html">
     4.2. Loss Functions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/modeling_summary.html">
     4.3. Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../04/modeling_exercises.html">
     4.4. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../05/cycle_case_study_intro.html">
   5. [In progress] Case Study: Why is my Bus Always Late?
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Rectangular Data
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../06/pandas_intro.html">
   6. Working With Dataframes Using pandas
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/pandas_subsetting.html">
     6.1. Subsetting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/pandas_aggregating.html">
     6.2. Aggregating
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/pandas_joining.html">
     6.3. Joining
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/pandas_transforming.html">
     6.4. Transforming
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/pandas_other_reps.html">
     6.5. How are Dataframes Different from Other Data Representations?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/pandas_summary.html">
     6.6. Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../06/pandas_exercises.html">
     6.7. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../07/sql_intro.html">
   7. Working With Relations Using SQL
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
  <label for="toctree-checkbox-6">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/sql_subsetting.html">
     7.1. Subsetting
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/sql_aggregating.html">
     7.2. Aggregating
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/sql_joining.html">
     7.3. Joining
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/sql_transforming.html">
     7.4. Transforming
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/sql_other_reps.html">
     7.5. How are Relations Different from Other Data Representations?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/sql_summary.html">
     7.6. Conclusion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../07/sql_exercises.html">
     7.7. Exercises
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Understanding The Data
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../08/files_intro.html">
   8. Wrangling Files
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
  <label for="toctree-checkbox-7">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../08/files_datasets.html">
     8.1. Data Source Examples
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08/files_formats.html">
     8.2. File Formats
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08/files_size.html">
     8.3. File Size
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08/files_command_line.html">
     8.4. The Shell and Command Line Tools
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08/files_granularity.html">
     8.5. Table Shape and Granularity
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../08/files_summary.html">
     8.6. Summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../09/wrangling_intro.html">
   9. Wrangling Dataframes
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
  <label for="toctree-checkbox-8">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/wrangling_co2.html">
     9.1. Example: Wrangling CO2 Measurements from Mauna Loa Observatory
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/wrangling_checks.html">
     9.2. Quality Checks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/wrangling_missing.html">
     9.3. Missing Values and Records
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/wrangling_transformations.html">
     9.4. Transformations and Timestamps
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/wrangling_structure.html">
     9.5. Modifying Structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/wrangling_restaurants.html">
     9.6. Example: Wrangling Restaurant Safety Violations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../09/wrangling_summary.html">
     9.7. Summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../10/eda_intro.html">
   10. Exploratory Data Analysis
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../10/eda_feature_types.html">
     10.1. Feature Types
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10/eda_distributions.html">
     10.2. What to Look For in a Distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10/eda_relationships.html">
     10.3. What to Look For in a Relationship?
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10/eda_guidelines.html">
     10.4. Guidelines for Exploration
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10/eda_example.html">
     10.5. Example: Sale Prices for Houses
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../10/eda_summary.html">
     10.6. Summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../11/viz_intro.html">
   11. Data Visualization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" type="checkbox"/>
  <label for="toctree-checkbox-10">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_scale.html">
     11.1. Choosing Scale to Reveal Structure
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_smoothing.html">
     11.2. Smoothing and Aggregating Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_comparisons.html">
     11.3. Facilitating Meaningful Comparisons
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_data_design.html">
     11.4. Incorporating the Data Design
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_context.html">
     11.5. Adding Context
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_plotly.html">
     11.6. Creating Plots Using
     <code class="docutils literal notranslate">
      <span class="pre">
       plotly
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_other_tools.html">
     11.7. Other Tools for Visualization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../11/viz_summary.html">
     11.8. Summary
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="pa_intro.html">
   12. Case Study: Data Science for Accurate and Timely Air Quality Measurements
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" type="checkbox"/>
  <label for="toctree-checkbox-11">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     12.1. Finding Collocated Sensors
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pa_cleaning_aqs.html">
     12.2. Exploring and Cleaning AQS Sensor Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pa_cleaning_purpleair.html">
     12.3. Exploring and Cleaning PurpleAir Sensor Data
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pa_modeling.html">
     12.4. Creating a Model to Correct PurpleAir Measurements
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pa_conclusion.html">
     12.5. In Conclusion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="pa_exercises.html">
     12.6. Exercises
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Other Data Sources
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../13/text_intro.html">
   13. Working with Text
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" type="checkbox"/>
  <label for="toctree-checkbox-12">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../13/text_examples.html">
     13.1. Examples of Text and Tasks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../13/text_strings.html">
     13.2. String Manipulation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../13/text_regex.html">
     13.3. Regular Expressions
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../13/text_sotu.html">
     13.4. Text Analysis
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../13/text_summary.html">
     13.5. Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../13/text_exercises.html">
     13.6. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../14/web_intro.html">
   14. Web Technologies
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" type="checkbox"/>
  <label for="toctree-checkbox-13">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../14/web_http.html">
     14.1. HTTP
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../14/web_rest.html">
     14.2. [In Progress] REST
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../14/web_html.html">
     14.3. [In Progress] XPath and HTML
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Linear Modeling
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../15/linear_intro.html">
   15. Linear Models
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" type="checkbox"/>
  <label for="toctree-checkbox-14">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../15/linear_simple.html">
     15.1. Simple Linear Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../15/linear_simple_fit.html">
     15.2. Fitting the Simple Linear Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../15/linear_multi.html">
     15.3. Multiple Linear Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../15/linear_multi_fit.html">
     15.4. Fitting the Multiple Linear Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../15/linear_feature_eng.html">
     15.5. Feature Engineering
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../15/linear_summary.html">
     15.6. Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../15/linear_exercises.html">
     15.7. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../16/inf_pred_gen_intro.html">
   16. Theory for Inference and Prediction
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" type="checkbox"/>
  <label for="toctree-checkbox-15">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_dist.html">
     16.1. Distributions: Population, Empirical, Sampling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_HT.html">
     16.2. Basics of Hypothesis Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_boot.html">
     16.3. Bootstrapping for Inference
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_CI.html">
     16.4. Basics of Confidence Intervals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_cautions.html">
     16.5. A Closer look at hypothesis tests and confidence intervals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_PI.html">
     16.6. Basics of Prediction Intervals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_prob.html">
     16.7. Probability Distribution for a Statistic
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../16/inf_pred_gen_Exercises.html">
     16.8. Exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../17/gradient_descent.html">
   17. Gradient Descent and Numerical Optimization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" type="checkbox"/>
  <label for="toctree-checkbox-16">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../17/gradient_basics.html">
     17.1. Loss Minimization Using a Program
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../17/gradient_descent_define.html">
     17.2. Gradient Descent
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../17/gradient_convexity.html">
     17.3. Convexity
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../17/gradient_stochastic.html">
     17.4. Stochastic Gradient Descent
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../17/gradient_lin_reg.html">
     17.5. Fitting a Linear Model Using Gradient Descent
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../18/donkey_intro.html">
   18. Case Study: How to Weigh a Donkey
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" type="checkbox"/>
  <label for="toctree-checkbox-17">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../18/donkey_scope.html">
     18.1. Donkey Study Question and Scope
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../18/donkey_clean.html">
     18.2. Wrangling and Transforming
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../18/donkey_eda.html">
     18.4. Exploring
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../18/donkey_model.html">
     18.5. Modeling a Donkey’s Weight
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../18/donkey_summary.html">
     18.6. Summary
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../18/donkey_exercises.html">
     18.7. Exercises
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Multiple Linear Modeling
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../19/mult_intro.html">
   19. [In progress] Multiple Linear Regression
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" type="checkbox"/>
  <label for="toctree-checkbox-18">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../19/mult_model.html">
     19.1. Multiple Linear Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../19/mult_inference.html">
     19.2. Inference for Multiple Linear Regression
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../20/feature_engineering.html">
   20. Feature Engineering
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" type="checkbox"/>
  <label for="toctree-checkbox-19">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../20/feature_one_hot.html">
     20.1. The Walmart dataset
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../20/feature_polynomial.html">
     20.2. Predicting Ice Cream Ratings
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../21/bias_intro.html">
   21. The Bias-Variance Tradeoff
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" type="checkbox"/>
  <label for="toctree-checkbox-20">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../21/bias_risk.html">
     21.1. Risk and Loss Minimization
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../21/bias_modeling.html">
     21.2. Model Bias and Variance
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../21/bias_cv.html">
     21.3. Cross-Validation
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../22/reg_intro.html">
   22. Regularization
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-21" name="toctree-checkbox-21" type="checkbox"/>
  <label for="toctree-checkbox-21">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../22/reg_intuition.html">
     22.1. Regularization Intuition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../22/reg_ridge.html">
     22.2. L2 Regularization: Ridge Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../22/reg_lasso.html">
     22.3. L1 Regularization: Lasso Regression
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../23/mult_case_intro.html">
   23. [In progress] Case Study: Multiple Linear Models
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Classification
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../24/classification_intro.html">
   24. Classification
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-22" name="toctree-checkbox-22" type="checkbox"/>
  <label for="toctree-checkbox-22">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_prob.html">
     24.1. Regression on Probabilities
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_log_model.html">
     24.2. The Logistic Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_cost.html">
     24.3. A Loss Function for the Logistic Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_log_reg.html">
     24.4. Using Logistic Regression
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_cost_justification.html">
     24.5. Approximating the Empirical Probability Distribution
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_sgd.html">
     24.6. Fitting a Logistic Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_sensitivity_specificity.html">
     24.7. Evaluating Logistic Models
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../24/classification_multiclass.html">
     24.8. Multiclass Classification
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Replicability
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../25/repl_intro.html">
   25. [In progress] Replicable Research
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-23" name="toctree-checkbox-23" type="checkbox"/>
  <label for="toctree-checkbox-23">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../25/repl_phacking.html">
     25.1. P-hacking
    </a>
   </li>
  </ul>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Extra Topics
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../26/pca_intro.html">
   26. Dimensionality Reduction and PCA
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-24" name="toctree-checkbox-24" type="checkbox"/>
  <label for="toctree-checkbox-24">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../26/pca_dims.html">
     26.1. Dimensions of a Data Table
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../26/pca_svd.html">
     26.2. PCA using the Singular Value Decomposition
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../26/pca_in_practice.html">
     26.3. PCA in Practice
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../27/dtrees_intro.html">
   27. [In progress] Decision Trees and Random Forests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../28/clustering_intro.html">
   28. [In progress] Clustering
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../a01/prob_review.html">
   Probability Review
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../a02/vector_space_review.html">
   Vector Space Review
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../a03/hyp_intro.html">
   Statistical Inference Review
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-25" name="toctree-checkbox-25" type="checkbox"/>
  <label for="toctree-checkbox-25">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../a03/hyp_introduction.html">
     Hypothesis Testing and Confidence Intervals
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../a03/hyp_introduction_part2.html">
     Permutation Test
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../a04/ref_intro.html">
   Reference Tables
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-26" name="toctree-checkbox-26" type="checkbox"/>
  <label for="toctree-checkbox-26">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../a04/ref_pandas.html">
     pandas
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../a04/ref_seaborn.html">
     Seaborn
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../a04/ref_matplotlib.html">
     matplotlib
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../a04/ref_sklearn.html">
     scikit-learn
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../a05/contributors.html">
   Contributors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../references.html">
   References
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/ch/12/pa_collocated.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        
        <a class="jupyterhub-button" href="https://datahub.berkeley.edu/hub/user-redirect/git-pull?repo=https://github.com/ds-100/textbook&urlpath=tree/textbook/content/ch/12/pa_collocated.ipynb&branch=master"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch JupyterHub" data-toggle="tooltip"
                data-placement="left"><img class="jupyterhub-button-logo"
                    src="../../_static/images/logo_jupyterhub.svg"
                    alt="Interact on JupyterHub">JupyterHub</button></a>
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#wrangling-the-list-of-aqs-sites">
   12.1.1. Wrangling the List of AQS Sites
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#whats-the-granularity">
     12.1.1.1. What’s the granularity?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subsetting">
     12.1.1.2. Subsetting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#wrangling-the-list-of-purpleair-sites">
   12.1.2. Wrangling the List of PurpleAir Sites
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     12.1.2.1. What’s the Granularity?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     12.1.2.2. Subsetting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-aqs-and-purpleair-data">
   12.1.3. Joining AQS and PurpleAir Data
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Finding Collocated Sensors</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#wrangling-the-list-of-aqs-sites">
   12.1.1. Wrangling the List of AQS Sites
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#whats-the-granularity">
     12.1.1.1. What’s the granularity?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subsetting">
     12.1.1.2. Subsetting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#wrangling-the-list-of-purpleair-sites">
   12.1.2. Wrangling the List of PurpleAir Sites
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     12.1.2.1. What’s the Granularity?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     12.1.2.2. Subsetting
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#joining-aqs-and-purpleair-data">
   12.1.3. Joining AQS and PurpleAir Data
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="section" id="finding-collocated-sensors">
<span id="ch-pa-collocated"></span><h1><span class="section-number">12.1. </span>Finding Collocated Sensors<a class="headerlink" href="#finding-collocated-sensors" title="Permalink to this headline">¶</a></h1>
<p>When starting an analysis, we like to begin with a research question.
In this case, our research question might be:
“How do we correct PurpleAir sensor readings so that they match AQS sensor readings?”
We focus specifically on readings for PM2.5 particles, which are particles that are smaller than 2.5
micrometers in diameter.
These particles are small enough to be inhaled into the lungs, pose the greatest
risk to health, and are especially common in wood smoke.</p>
<p>Our analysis begins by finding collocated pairs of AQS and PurpleAir sensors—sensors that are placed immediately next to each other.
This step is important because it lets us reduce the effects of other variables that might caused differences in sensor readings.
Consider what would happen if we compared an AQS sensor placed inside a building with a PurpleAir sensor placed outside the building.
The two sensors would have different readings, but some of these differences
would happen because the sensors are exposed to different environments.
Ensuring that sensors are truly collocated lets us say that the differences in sensor
readings is caused the different ways the sensors are built, rather than
other potential confounding variables.</p>
<p>Barkjohn et al.’s analysis found pairs of AQS and PurpleAir sensors that
are installed within 50 meters of each other.
Then, they contacted each AQS site to see whether the people maintaining the site
also maintained a PurpleAir sensor.
This extra effort gave them confidence that their sensor pairs were truly collocated.</p>
<p>In this section, we’ll explore and clean data from the AQS and PurpleAir.
Then, we’ll perform a similar join to construct a list of potentially collocated sensors.
We won’t contact AQS sites ourselves;
instead, we’ll proceed with the analysis by reusing Barkjohn et al.’s list of truly
collocated sensors.</p>
<p>We’ve downloaded a list of AQS and PurpleAir sensors in <code class="docutils literal notranslate"><span class="pre">data/list_of_aqs_sites.csv</span></code>
and <code class="docutils literal notranslate"><span class="pre">data/list_of_purpleair_sensors.json</span></code>.
Let’s begin by reading these files into <code class="docutils literal notranslate"><span class="pre">pandas</span></code>.
First, we check file sizes to see whether they are reasonable to load into memory.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls -lLh data/list_of*
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-rw-r--r--  1 sam  staff   4.8M Oct 27 16:54 data/list_of_aqs_sites.csv
-rw-r--r--  1 sam  staff   3.8M Oct 22 16:10 data/list_of_purpleair_sensors.json
</pre></div>
</div>
</div>
</div>
<p>Both files are relatively small. We’ll start with the list of AQS sites.</p>
<div class="section" id="wrangling-the-list-of-aqs-sites">
<h2><span class="section-number">12.1.1. </span>Wrangling the List of AQS Sites<a class="headerlink" href="#wrangling-the-list-of-aqs-sites" title="Permalink to this headline">¶</a></h2>
<p>Let’s load the CSV file into <code class="docutils literal notranslate"><span class="pre">pandas</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aqs_sites</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/list_of_aqs_sites.csv&#39;</span><span class="p">)</span>

<span class="c1"># The table output is fairly large, so display 2 rows</span>
<span class="n">aqs_sites</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AQS_Site_ID</th>
      <th>POC</th>
      <th>State</th>
      <th>City</th>
      <th>...</th>
      <th>Reporting_Agency</th>
      <th>Parameter_Name</th>
      <th>Annual_URLs</th>
      <th>Daily_URLs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01-003-0010</td>
      <td>1</td>
      <td>Alabama</td>
      <td>Fairhope</td>
      <td>...</td>
      <td>Al Dept Of Env Mgt</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01-027-0001</td>
      <td>1</td>
      <td>Alabama</td>
      <td>Ashland</td>
      <td>...</td>
      <td>Al Dept Of Env Mgt</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 28 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Number of rows and columns in the table</span>
<span class="n">aqs_sites</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(1333, 28)
</pre></div>
</div>
</div>
</div>
<p>This dataframe comes from the AQS map of sites (<a class="reference external" href="https://www.epa.gov/outdoor-air-quality-data/interactive-map-air-quality-monitors">link</a>).
We filtered the map to show only the AQS sites that measure PM2.5, then downloaded
the list as a CSV using the map’s web app.</p>
<p>There are 28 columns in the table.
Jupyter hides the middle columns to avoid overfilling the screen.
However, we want to see what the columns are so that we can find out which columns are
most useful for us.
To do this, we’ll use a trick. We’ll slice out the first row of <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code>, then
convert it to a dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aqs_sites</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AQS_Site_ID</th>
      <td>01-003-0010</td>
    </tr>
    <tr>
      <th>POC</th>
      <td>1</td>
    </tr>
    <tr>
      <th>State</th>
      <td>Alabama</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>Parameter_Name</th>
      <td>PM2.5</td>
    </tr>
    <tr>
      <th>Annual_URLs</th>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>Daily_URLs</th>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
  </tbody>
</table>
<p>28 rows × 1 columns</p>
</div></div></div>
</div>
<p>In this dataframe, each row corresponds to one column of <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code>.
Next, we’ll tell <code class="docutils literal notranslate"><span class="pre">pandas</span></code> to display more rows so that we can browse all the
columns are once.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="n">rows_to_show</span> <span class="o">=</span> <span class="mi">28</span>
<span class="k">with</span> <span class="n">pd</span><span class="o">.</span><span class="n">option_context</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="n">rows_to_show</span><span class="p">):</span>
    <span class="n">display</span><span class="p">(</span><span class="n">aqs_sites</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>AQS_Site_ID</th>
      <td>01-003-0010</td>
    </tr>
    <tr>
      <th>POC</th>
      <td>1</td>
    </tr>
    <tr>
      <th>State</th>
      <td>Alabama</td>
    </tr>
    <tr>
      <th>City</th>
      <td>Fairhope</td>
    </tr>
    <tr>
      <th>CBSA</th>
      <td>Daphne-Fairhope-Foley, AL</td>
    </tr>
    <tr>
      <th>Local_Site_Name</th>
      <td>FAIRHOPE, Alabama</td>
    </tr>
    <tr>
      <th>Address</th>
      <td>FAIRHOPE HIGH SCHOOL, 1 PIRATE DRIVE, FAIRHOPE...</td>
    </tr>
    <tr>
      <th>Datum</th>
      <td>NAD83</td>
    </tr>
    <tr>
      <th>Latitude</th>
      <td>30.5</td>
    </tr>
    <tr>
      <th>Longitude</th>
      <td>-87.88</td>
    </tr>
    <tr>
      <th>LatLon_Accuracy_meters</th>
      <td>4.0</td>
    </tr>
    <tr>
      <th>Elevation_meters_MSL</th>
      <td>37.19</td>
    </tr>
    <tr>
      <th>Monitor_Start_Date</th>
      <td>1/1/2000</td>
    </tr>
    <tr>
      <th>Last_Sample_Date</th>
      <td>6/30/2021</td>
    </tr>
    <tr>
      <th>Active</th>
      <td>Yes</td>
    </tr>
    <tr>
      <th>Measurement_Scale</th>
      <td>NEIGHBORHOOD</td>
    </tr>
    <tr>
      <th>Measurement_Scale_Definition</th>
      <td>500 M TO 4KM</td>
    </tr>
    <tr>
      <th>Sample_Duration</th>
      <td>24 HOUR</td>
    </tr>
    <tr>
      <th>Sample_Collection_Frequency</th>
      <td>EVERY 3RD DAY</td>
    </tr>
    <tr>
      <th>Sample_Collection_Method</th>
      <td>R &amp; P Model 2025 PM-2.5 Sequential Air Sampler...</td>
    </tr>
    <tr>
      <th>Sample_Analysis_Method</th>
      <td>Gravimetric</td>
    </tr>
    <tr>
      <th>Method_Reference_ID</th>
      <td>RFPS-1006-145</td>
    </tr>
    <tr>
      <th>FRMFEM</th>
      <td>Yes</td>
    </tr>
    <tr>
      <th>Monitor_Type</th>
      <td>SLAMS</td>
    </tr>
    <tr>
      <th>Reporting_Agency</th>
      <td>Al Dept Of Env Mgt</td>
    </tr>
    <tr>
      <th>Parameter_Name</th>
      <td>PM2.5</td>
    </tr>
    <tr>
      <th>Annual_URLs</th>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>Daily_URLs</th>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For a complete description of the columns, we can reference the data dictionary
that the AQS provides on their website (<a class="reference external" href="https://aqs.epa.gov/aqsweb/airdata/FileFormats.html#_monitor_description_file">link</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We often want to fiddle with <code class="docutils literal notranslate"><span class="pre">pandas</span></code> display options to show/hide rows of a
large dataframe. For convenience, we’ve defined a method called <code class="docutils literal notranslate"><span class="pre">display_df</span></code>
that has the basic logic of the cell above. In the future, we’ll use this code
instead:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">display_df</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="mi">28</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="whats-the-granularity">
<h3><span class="section-number">12.1.1.1. </span>What’s the granularity?<a class="headerlink" href="#whats-the-granularity" title="Permalink to this headline">¶</a></h3>
<p>For now, most important observation is that the <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code> dataframe doesn’t
contain sensor recordings. It only has a list of AQS sites. In other words, we
might expect that the granularity of <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code> is that each row represents
a single AQS site.
To check this, we can see whether the <code class="docutils literal notranslate"><span class="pre">AQS_Site_ID</span></code>s are unique.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aqs_sites</span><span class="p">[</span><span class="s1">&#39;AQS_Site_ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>19-163-0015    4
19-153-0030    4
49-005-0007    4
              ..
23-005-0015    1
23-019-0017    1
80-002-0014    1
Name: AQS_Site_ID, Length: 921, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>It looks like some sites appear multiple times in this dataframe.
Unfortunately, this means that the granularity of <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code> is probably at a
finer granularity than the individual site level.
Why are sites duplicated? We can take a closer look at some duplicated sites.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dup_site</span> <span class="o">=</span> <span class="n">aqs_sites</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;AQS_Site_ID == &#39;19-163-0015&#39;&quot;</span><span class="p">)</span>
<span class="n">dup_site</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AQS_Site_ID</th>
      <th>POC</th>
      <th>State</th>
      <th>City</th>
      <th>...</th>
      <th>Reporting_Agency</th>
      <th>Parameter_Name</th>
      <th>Annual_URLs</th>
      <th>Daily_URLs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>458</th>
      <td>19-163-0015</td>
      <td>1</td>
      <td>Iowa</td>
      <td>Davenport</td>
      <td>...</td>
      <td>University Hygenic Laboratory (University of I...</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>459</th>
      <td>19-163-0015</td>
      <td>2</td>
      <td>Iowa</td>
      <td>Davenport</td>
      <td>...</td>
      <td>University Hygenic Laboratory (University of I...</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>460</th>
      <td>19-163-0015</td>
      <td>3</td>
      <td>Iowa</td>
      <td>Davenport</td>
      <td>...</td>
      <td>University Hygenic Laboratory (University of I...</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>461</th>
      <td>19-163-0015</td>
      <td>4</td>
      <td>Iowa</td>
      <td>Davenport</td>
      <td>...</td>
      <td>University Hygenic Laboratory (University of I...</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 28 columns</p>
</div></div></div>
</div>
<p>This display isn’t very helpful since it hides the middle columns.
In practice, we’d interactively display columns until we find some that appear
to distinguish between the rows.
Here, we’ll simply skip ahead and show a few columns of interest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cols_that_distinguish</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AQS_Site_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;POC&#39;</span><span class="p">,</span> <span class="s1">&#39;Monitor_Start_Date&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;Last_Sample_Date&#39;</span><span class="p">,</span> <span class="s1">&#39;Sample_Collection_Method&#39;</span><span class="p">]</span>
<span class="n">dup_site</span><span class="p">[</span><span class="n">cols_that_distinguish</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AQS_Site_ID</th>
      <th>POC</th>
      <th>Monitor_Start_Date</th>
      <th>Last_Sample_Date</th>
      <th>Sample_Collection_Method</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>458</th>
      <td>19-163-0015</td>
      <td>1</td>
      <td>1/27/1999</td>
      <td>8/31/2021</td>
      <td>R &amp; P Model 2025 PM-2.5 Sequential Air Sampler...</td>
    </tr>
    <tr>
      <th>459</th>
      <td>19-163-0015</td>
      <td>2</td>
      <td>2/9/2013</td>
      <td>8/26/2021</td>
      <td>R &amp; P Model 2025 PM-2.5 Sequential Air Sampler...</td>
    </tr>
    <tr>
      <th>460</th>
      <td>19-163-0015</td>
      <td>3</td>
      <td>1/1/2019</td>
      <td>9/30/2021</td>
      <td>Teledyne T640 at 5.0 LPM</td>
    </tr>
    <tr>
      <th>461</th>
      <td>19-163-0015</td>
      <td>4</td>
      <td>1/1/2019</td>
      <td>9/30/2021</td>
      <td>Teledyne T640 at 5.0 LPM</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The data dictionary for this table states this about the <code class="docutils literal notranslate"><span class="pre">POC</span></code> column:</p>
<blockquote>
<div><p>This is the “Parameter Occurrence Code” used to distinguish different instruments that measure the same parameter at the same site.</p>
</div></blockquote>
<p>In this case, there are four instruments at this site that all
measure PM2.5. So, it appears that the granularity of the <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code> dataframe
is that each row represents a single instrument at an AQS site.</p>
<p>For simplicity, the AQS also reports one average measurement for each site
rather than one measurement for each sensor at a site.
We’ll proceed by using this average measurement per site.
Since we’re primarily using this data to match AQS site with PurpleAir sensors,
we’ll adjust the granularity of this data by grouping by site ID, then taking
the first row within each group.
This removes duplicated site IDs and is appropriate here because we only need
the location of each site to match with PurpleAir sensors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">rollup_dup_sites</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;AQS_Site_ID&#39;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aqs_sites</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/list_of_aqs_sites.csv&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">rollup_dup_sites</span><span class="p">))</span>
<span class="n">aqs_sites</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>AQS_Site_ID</th>
      <th>POC</th>
      <th>State</th>
      <th>City</th>
      <th>...</th>
      <th>Reporting_Agency</th>
      <th>Parameter_Name</th>
      <th>Annual_URLs</th>
      <th>Daily_URLs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01-003-0010</td>
      <td>1</td>
      <td>Alabama</td>
      <td>Fairhope</td>
      <td>...</td>
      <td>Al Dept Of Env Mgt</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01-027-0001</td>
      <td>1</td>
      <td>Alabama</td>
      <td>Ashland</td>
      <td>...</td>
      <td>Al Dept Of Env Mgt</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>01-049-1003</td>
      <td>1</td>
      <td>Alabama</td>
      <td>Crossville</td>
      <td>...</td>
      <td>Al Dept Of Env Mgt</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>918</th>
      <td>56-039-1013</td>
      <td>1</td>
      <td>Wyoming</td>
      <td>None</td>
      <td>...</td>
      <td>National Park Service</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>919</th>
      <td>80-002-0012</td>
      <td>3</td>
      <td>Country Of Mexico</td>
      <td>Mexicali</td>
      <td>...</td>
      <td>Tracer Technologies</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
    <tr>
      <th>920</th>
      <td>80-002-0014</td>
      <td>3</td>
      <td>Country Of Mexico</td>
      <td>Mexicali</td>
      <td>...</td>
      <td>Tracer Technologies</td>
      <td>PM2.5</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
      <td>&lt;a href='https://www3.epa.gov/cgi-bin/broker?_...</td>
    </tr>
  </tbody>
</table>
<p>921 rows × 28 columns</p>
</div></div></div>
</div>
<p>Now, each row of <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code> corresponds to one AQS site, which is the granularity
we want.</p>
</div>
<div class="section" id="subsetting">
<h3><span class="section-number">12.1.1.2. </span>Subsetting<a class="headerlink" href="#subsetting" title="Permalink to this headline">¶</a></h3>
<p>To match AQS sites with PurpleAir sensors, we only need the site ID, latitude, and longitude.
So, we’ll subset and rename the columns of interest.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subset_aqs</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;AQS_Site_ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span> <span class="s1">&#39;Longitude&#39;</span><span class="p">]]</span>
    <span class="n">subset</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;site_id&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">subset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aqs_sites</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;data/list_of_aqs_sites.csv&#39;</span><span class="p">)</span>
             <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">rollup_dup_sites</span><span class="p">)</span>
             <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">subset_aqs</span><span class="p">))</span>

<span class="n">aqs_sites</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>site_id</th>
      <th>lat</th>
      <th>lon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01-003-0010</td>
      <td>30.50</td>
      <td>-87.88</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01-027-0001</td>
      <td>33.28</td>
      <td>-85.80</td>
    </tr>
    <tr>
      <th>2</th>
      <td>01-049-1003</td>
      <td>34.29</td>
      <td>-85.97</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>918</th>
      <td>56-039-1013</td>
      <td>44.37</td>
      <td>-110.83</td>
    </tr>
    <tr>
      <th>919</th>
      <td>80-002-0012</td>
      <td>32.63</td>
      <td>-115.45</td>
    </tr>
    <tr>
      <th>920</th>
      <td>80-002-0014</td>
      <td>32.63</td>
      <td>-115.50</td>
    </tr>
  </tbody>
</table>
<p>921 rows × 3 columns</p>
</div></div></div>
</div>
<p>Now, the <code class="docutils literal notranslate"><span class="pre">aqs_sites</span></code> dataframe is ready and we’ll move to the PurpleAir sites.</p>
</div>
</div>
<div class="section" id="wrangling-the-list-of-purpleair-sites">
<h2><span class="section-number">12.1.2. </span>Wrangling the List of PurpleAir Sites<a class="headerlink" href="#wrangling-the-list-of-purpleair-sites" title="Permalink to this headline">¶</a></h2>
<p>Unlike the AQS sites, the file containing PurpleAir sensor data comes in the
JSON format. This file is provided by the PurpleAir website.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls -lLh data/list_of_purpleair_sensors.json
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-rw-r--r--  1 sam  staff   3.8M Oct 22 16:10 data/list_of_purpleair_sensors.json
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Previews first few lines of the file. The `cut` command limits the output to</span>
<span class="c1"># the first 70 characters for each line since the lines are quite long.</span>
<span class="o">!</span>head data/list_of_purpleair_sensors.json <span class="p">|</span> cut -c <span class="m">1</span>-70
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&quot;version&quot;:&quot;7.0.30&quot;,
&quot;fields&quot;:
[&quot;ID&quot;,&quot;pm&quot;,&quot;pm_cf_1&quot;,&quot;pm_atm&quot;,&quot;age&quot;,&quot;pm_0&quot;,&quot;pm_1&quot;,&quot;pm_2&quot;,&quot;pm_3&quot;,&quot;pm_4&quot;
&quot;data&quot;:[
[20,0.0,0.0,0.0,0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,97,0.0,0.0,0.0,0.0,0.0,0
[47,null,null,null,4951,null,null,null,null,null,null,null,96,null,nul
[53,0.0,0.0,0.0,0,0.0,0.0,0.0,0.0,1.2,5.2,6.0,97,0.0,0.5,702.3,57.5,6.
[74,0.0,0.0,0.0,0,0.0,0.0,0.0,0.0,0.0,0.0,0.0,97,0.0,0.0,0.0,0.0,0.0,0
[77,9.8,9.8,9.8,1,9.8,10.7,11.0,11.2,13.8,15.1,15.5,97,9.7,9.8,6523.5,
[81,6.5,6.5,6.5,0,6.5,6.1,6.1,6.6,8.1,8.3,9.7,97,5.9,6.8,4058.9,346.1,
</pre></div>
</div>
</div>
</div>
<p>From the first few lines of the JSON file, we can guess that the data rows are
stored in the <code class="docutils literal notranslate"><span class="pre">&quot;data&quot;</span></code> key and the column labels are stored in the <code class="docutils literal notranslate"><span class="pre">&quot;fields&quot;</span></code> key.
We can first use Python’s <code class="docutils literal notranslate"><span class="pre">json</span></code> library to read in the file as a Python <code class="docutils literal notranslate"><span class="pre">dict</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;data/list_of_purpleair_sensors.json&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">pa_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

<span class="nb">list</span><span class="p">(</span><span class="n">pa_json</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;version&#39;, &#39;fields&#39;, &#39;data&#39;, &#39;count&#39;]
</pre></div>
</div>
</div>
</div>
<p>Then, we’ll create a dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pa_sites</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pa_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">pa_json</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span>
<span class="n">pa_sites</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ID</th>
      <th>pm</th>
      <th>pm_cf_1</th>
      <th>pm_atm</th>
      <th>...</th>
      <th>Voc</th>
      <th>Ozone1</th>
      <th>Adc</th>
      <th>CH</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>20</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.01</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>47</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>...</td>
      <td>NaN</td>
      <td>0.72</td>
      <td>0.72</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>53</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.00</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>23135</th>
      <td>132237</td>
      <td>5.3</td>
      <td>5.3</td>
      <td>5.3</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.00</td>
      <td>3</td>
    </tr>
    <tr>
      <th>23136</th>
      <td>132431</td>
      <td>3.2</td>
      <td>3.2</td>
      <td>3.2</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.03</td>
      <td>3</td>
    </tr>
    <tr>
      <th>23137</th>
      <td>132471</td>
      <td>0.5</td>
      <td>0.5</td>
      <td>0.5</td>
      <td>...</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.05</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
<p>23138 rows × 36 columns</p>
</div></div></div>
</div>
<p>Like the AQS data, there are many more columns in this dataframe than <code class="docutils literal notranslate"><span class="pre">pandas</span></code>
will display. Another quick way to look at the columns is to simply print
the column labels.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pa_sites</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Index([&#39;ID&#39;, &#39;pm&#39;, &#39;pm_cf_1&#39;, &#39;pm_atm&#39;, &#39;age&#39;, &#39;pm_0&#39;, &#39;pm_1&#39;, &#39;pm_2&#39;, &#39;pm_3&#39;,
       &#39;pm_4&#39;, &#39;pm_5&#39;, &#39;pm_6&#39;, &#39;conf&#39;, &#39;pm1&#39;, &#39;pm_10&#39;, &#39;p1&#39;, &#39;p2&#39;, &#39;p3&#39;, &#39;p4&#39;,
       &#39;p5&#39;, &#39;p6&#39;, &#39;Humidity&#39;, &#39;Temperature&#39;, &#39;Pressure&#39;, &#39;Elevation&#39;, &#39;Type&#39;,
       &#39;Label&#39;, &#39;Lat&#39;, &#39;Lon&#39;, &#39;Icon&#39;, &#39;isOwner&#39;, &#39;Flags&#39;, &#39;Voc&#39;, &#39;Ozone1&#39;,
       &#39;Adc&#39;, &#39;CH&#39;],
      dtype=&#39;object&#39;)
</pre></div>
</div>
</div>
</div>
<p>In this case, we can guess that the columns we’re most interested in are the
sensor IDs (<code class="docutils literal notranslate"><span class="pre">ID</span></code>), sensor labels (<code class="docutils literal notranslate"><span class="pre">Label</span></code>), latitude (<code class="docutils literal notranslate"><span class="pre">Lat</span></code>), and longitude (<code class="docutils literal notranslate"><span class="pre">Lon</span></code>).
Again, we consulted the data dictionary on the PurpleAir website to double check
what the columns represent.</p>
<div class="section" id="id1">
<h3><span class="section-number">12.1.2.1. </span>What’s the Granularity?<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p>Let’s check the <code class="docutils literal notranslate"><span class="pre">ID</span></code> column for duplicates, as we did for the AQS data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pa_sites</span><span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>20        1
88775     1
88771     1
         ..
57357     1
57355     1
132471    1
Name: ID, Length: 23138, dtype: int64
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">value_counts()</span></code> method lists the counts in descending order, so we can see
that every ID was included only once. This lets us verify that the granularity of
this data is already at the individual sensor level, so we don’t need to perform
additional wrangling to adjust the granularity.</p>
</div>
<div class="section" id="id2">
<h3><span class="section-number">12.1.2.2. </span>Subsetting<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>Next, we’ll subset the PurpleAir data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">subset_pa</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="n">subset</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;Label&#39;</span><span class="p">,</span> <span class="s1">&#39;Lat&#39;</span><span class="p">,</span> <span class="s1">&#39;Lon&#39;</span><span class="p">]]</span>
    <span class="n">subset</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">subset</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pa_sites</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pa_json</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">pa_json</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">subset_pa</span><span class="p">))</span>
<span class="n">pa_sites</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>label</th>
      <th>lat</th>
      <th>lon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>20</td>
      <td>Oakdale</td>
      <td>40.60</td>
      <td>-111.84</td>
    </tr>
    <tr>
      <th>1</th>
      <td>47</td>
      <td>OZONE TEST</td>
      <td>40.48</td>
      <td>-111.88</td>
    </tr>
    <tr>
      <th>2</th>
      <td>53</td>
      <td>Lakeshore</td>
      <td>40.25</td>
      <td>-111.70</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>23135</th>
      <td>132237</td>
      <td>1965 Valleyview Drive</td>
      <td>50.68</td>
      <td>-120.27</td>
    </tr>
    <tr>
      <th>23136</th>
      <td>132431</td>
      <td>Granite Dells</td>
      <td>34.24</td>
      <td>-111.31</td>
    </tr>
    <tr>
      <th>23137</th>
      <td>132471</td>
      <td>Joy's House</td>
      <td>34.01</td>
      <td>-117.66</td>
    </tr>
  </tbody>
</table>
<p>23138 rows × 4 columns</p>
</div></div></div>
</div>
<p>Now, the PurpleAir data is ready to join with the AQS data.</p>
</div>
</div>
<div class="section" id="joining-aqs-and-purpleair-data">
<h2><span class="section-number">12.1.3. </span>Joining AQS and PurpleAir Data<a class="headerlink" href="#joining-aqs-and-purpleair-data" title="Permalink to this headline">¶</a></h2>
<p>We have two dataframes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">aqs_sites</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>site_id</th>
      <th>lat</th>
      <th>lon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>01-003-0010</td>
      <td>30.50</td>
      <td>-87.88</td>
    </tr>
    <tr>
      <th>1</th>
      <td>01-027-0001</td>
      <td>33.28</td>
      <td>-85.80</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pa_sites</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>label</th>
      <th>lat</th>
      <th>lon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>20</td>
      <td>Oakdale</td>
      <td>40.60</td>
      <td>-111.84</td>
    </tr>
    <tr>
      <th>1</th>
      <td>47</td>
      <td>OZONE TEST</td>
      <td>40.48</td>
      <td>-111.88</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Our goal is to match rows from these two dataframes where the sites are within
50 meters of each other.
This is a bit more challenging than the joins
we’ve seen thus far.
For instance, one naive approach is to use the <code class="docutils literal notranslate"><span class="pre">merge</span></code> method of <code class="docutils literal notranslate"><span class="pre">pandas</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Does *not* join properly</span>
<span class="n">aqs_sites</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pa_sites</span><span class="p">,</span> <span class="n">left_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">],</span> <span class="n">right_on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>site_id</th>
      <th>lat</th>
      <th>lon</th>
      <th>id</th>
      <th>label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>06-111-1004</td>
      <td>34.45</td>
      <td>-119.23</td>
      <td>48393</td>
      <td>VCAPCD OJ</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>However, this matches AQS and PurpleAir sites that have the exact same latitude
and longitude.
We won’t use the code above because it doesn’t perform the join we want.
For each AQS site, we want to see find the PurpleAir sites that are
“close enough”, so we match rows even if they have slightly different
latitudes and longitudes.</p>
<p>But how much difference in latitude and longitude correspond to 50 meters?
Here, we’ll use a simple approximation: <code class="docutils literal notranslate"><span class="pre">111,111</span></code> meters in the
north-south direction roughly equal to
one degree of latitude, and <code class="docutils literal notranslate"><span class="pre">111,111</span> <span class="pre">*</span> <span class="pre">cos(latitude)</span></code> in the east-west direction
correspond to one degree of longitude <a class="footnote-reference brackets" href="#latlon" id="id3">1</a>.
Thus, we can find the latitude and longitude ranges that correspond to 25 meters
in each direction (to make a 50m by 50m rectangle around each point).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">magic_meters_per_lat</span> <span class="o">=</span> <span class="mi">111_111</span>
<span class="n">offset_in_m</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">offset_in_lat</span> <span class="o">=</span> <span class="n">offset_in_m</span> <span class="o">/</span> <span class="n">magic_meters_per_lat</span>
<span class="n">offset_in_lat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.000225000225000225
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># To simplify even more, we&#39;ll use the median latitude for the AQS sites</span>
<span class="n">median_latitude</span> <span class="o">=</span> <span class="n">aqs_sites</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
<span class="n">magic_meters_per_lon</span> <span class="o">=</span> <span class="mi">111_111</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">median_latitude</span><span class="p">))</span>
<span class="n">offset_in_lon</span> <span class="o">=</span> <span class="n">offset_in_m</span> <span class="o">/</span> <span class="n">magic_meters_per_lon</span>
<span class="n">offset_in_lon</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.000291515219937587
</pre></div>
</div>
</div>
</div>
<p>Finally, we’ll join AQS and PurpleAir sites together where the coordinates are
within the <code class="docutils literal notranslate"><span class="pre">offset_in_lat</span></code> and <code class="docutils literal notranslate"><span class="pre">offset_in_lon</span></code> of each other.
Doing this in SQL is much easier than doing it in <code class="docutils literal notranslate"><span class="pre">pandas</span></code>, so we’ll
push the tables into a temporary SQLite database, then run a query to read
the tables back into a dataframe.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlalchemy</span>

<span class="c1"># An empty database name uses an in-memory sqlite database that doesn&#39;t save</span>
<span class="c1"># any files to disk</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite://&#39;</span><span class="p">)</span>

<span class="n">aqs_sites</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;aqs&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">pa_sites</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;pa&#39;</span><span class="p">,</span> <span class="n">con</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">SELECT</span>
<span class="s1">  aqs.site_id AS aqs_id,</span>
<span class="s1">  pa.id AS pa_id,</span>
<span class="s1">  pa.label AS pa_label,</span>
<span class="s1">  aqs.lat AS aqs_lat,</span>
<span class="s1">  aqs.lon AS aqs_lon,</span>
<span class="s1">  pa.lat AS pa_lat,</span>
<span class="s1">  pa.lon AS pa_lon</span>
<span class="s1">FROM aqs JOIN pa</span>
<span class="s1">  ON  pa.lat - </span><span class="si">{</span><span class="n">offset_in_lat</span><span class="si">}</span><span class="s1"> &lt;= aqs.lat</span>
<span class="s1">  AND                             aqs.lat &lt;= pa.lat + </span><span class="si">{</span><span class="n">offset_in_lat</span><span class="si">}</span><span class="s1"></span>
<span class="s1">  AND pa.lon - </span><span class="si">{</span><span class="n">offset_in_lon</span><span class="si">}</span><span class="s1"> &lt;= aqs.lon</span>
<span class="s1">  AND                             aqs.lon &lt;= pa.lon + </span><span class="si">{</span><span class="n">offset_in_lon</span><span class="si">}</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">matched</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">db</span><span class="p">)</span>
<span class="n">matched</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>aqs_id</th>
      <th>pa_id</th>
      <th>pa_label</th>
      <th>aqs_lat</th>
      <th>aqs_lon</th>
      <th>pa_lat</th>
      <th>pa_lon</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>06-019-0011</td>
      <td>6568</td>
      <td>IMPROVE_FRES2</td>
      <td>36.79</td>
      <td>-119.77</td>
      <td>36.79</td>
      <td>-119.77</td>
    </tr>
    <tr>
      <th>1</th>
      <td>06-019-0011</td>
      <td>13485</td>
      <td>AMTS_Fresno</td>
      <td>36.79</td>
      <td>-119.77</td>
      <td>36.79</td>
      <td>-119.77</td>
    </tr>
    <tr>
      <th>2</th>
      <td>06-019-0011</td>
      <td>44427</td>
      <td>Fresno CARB CCAC</td>
      <td>36.79</td>
      <td>-119.77</td>
      <td>36.79</td>
      <td>-119.77</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>146</th>
      <td>53-061-1007</td>
      <td>3659</td>
      <td>Marysville 7th</td>
      <td>48.05</td>
      <td>-122.17</td>
      <td>48.05</td>
      <td>-122.17</td>
    </tr>
    <tr>
      <th>147</th>
      <td>53-063-0021</td>
      <td>54603</td>
      <td>Augusta 1 SRCAA</td>
      <td>47.67</td>
      <td>-117.36</td>
      <td>47.67</td>
      <td>-117.36</td>
    </tr>
    <tr>
      <th>148</th>
      <td>56-021-0100</td>
      <td>50045</td>
      <td>WDEQ-AQD Cheyenne NCore</td>
      <td>41.18</td>
      <td>-104.78</td>
      <td>41.18</td>
      <td>-104.78</td>
    </tr>
  </tbody>
</table>
<p>149 rows × 7 columns</p>
</div></div></div>
</div>
<p>We’ve achieved our goal—we matched AQS sites with PurpleAir sensors.
Barkjohn’s paper mentions that they found 42 candidate matches in August of 2018.
We ran this analysis using 2021 data, and we have 149 candidate matches.
Perhaps in the years between 2018 and 2021 many more AQS or PurpleAir
sensors were installed.
In either case, this part of the analysis provides a taste of the types of wrangling
we’ll use again in the rest of this chapter.
In the next section, we’ll wrangle, explore, and clean sensor data from an AQS site.</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="latlon"><span class="brackets"><a class="fn-backref" href="#id3">1</a></span></dt>
<dd><p>This estimation works by assuming that the Earth is perfectly spherical.
Then, one degree of latitude is <span class="math notranslate nohighlight">\( \frac{\pi}{180} \cdot r \)</span>, where <span class="math notranslate nohighlight">\( r \)</span> is the
radius of the Earth in meters.
Plugging in the average radius of the Earth gives 111,111 meters per degree of latitude.
Longitude is the same, but the radius of each “ring” around the Earth decreases
as we get closer to the poles, so we adjust by a factor of <span class="math notranslate nohighlight">\( \cos(\text{lat}) \)</span> .
It turns out that the Earth isn’t perfectly spherical, so these estimations
can’t be used for precise calculations, like landing a rocket.
But for our purposes they do just fine.</p>
</dd>
</dl>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./ch/12"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="pa_intro.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title"><span class="section-number">12. </span>Case Study: Data Science for Accurate and Timely Air Quality Measurements</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="pa_cleaning_aqs.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">12.2. </span>Exploring and Cleaning AQS Sensor Data</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Sam Lau, Joey Gonzalez, and Deb Nolan<br/>
    
        &copy; Copyright 2022.<br/>
      <div class="extra_footer">
        <p>
License: CC BY-NC-ND 4.0
</p>

      </div>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>